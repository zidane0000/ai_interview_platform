name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'api/**'
              - 'ai/**'
              - 'data/**'
              - 'config/**'
              - 'utils/**'
              - 'e2e/**'
              - 'main.go'
              - 'go.mod'
              - 'go.sum'
            frontend:
              - 'frontend/**'

  frontend-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      built: 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Build frontend
        run: cd frontend && npm ci && npm run build

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  backend-test:
    needs: [changes, frontend-build]
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: ${{ github.run_id }}
          POSTGRES_USER: postgres
          POSTGRES_DB: ai_interview_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Run unit tests with coverage
        run: |
          go test -race -coverprofile coverage.out -covermode atomic $(go list ./... | grep -v /e2e)
          go tool cover -func coverage.out

      - name: Build backend
        run: go build -o app

      - name: Start backend server
        run: |
          export DATABASE_URL="postgres://postgres:${{ github.run_id }}@localhost:5432/ai_interview_test"
          ./app &
          echo $! > backend.pid
          sleep 5

      - name: Wait for server ready
        run: timeout 30 bash -c 'until curl -f http://localhost:8080/health; do sleep 1; done'

      - name: Run E2E tests
        run: go test ./e2e/... -v

      - name: Cleanup
        if: always()
        run: kill $(cat backend.pid) || true

  frontend-test:
    needs: [changes, frontend-build]
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Lint
        run: cd frontend && npm run lint

      - name: Verify build artifacts
        run: test -d frontend/dist && echo "Frontend built successfully"

      - name: Test mock mode works
        run: |
          cd frontend
          VITE_USE_MOCK_DATA=true npm run dev &
          DEV_PID=$!
          timeout 30 bash -c 'until curl -f http://localhost:5173 >/dev/null 2>&1; do sleep 1; done'
          kill $DEV_PID || true
          echo "Mock mode works successfully"

  integration-build:
    needs: [changes, frontend-build]
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Build complete application
        run: go build -o app

      - name: Verify monorepo build
        run: |
          test -f app && echo "Monorepo build successful"
          test -d frontend/dist && echo "Frontend embedded successfully"
